<!-- 在 public 目录下创建 admin-dashboard.html -->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Vision Pro管理后台系统">
    <title>Vision Pro 管理中心</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" />
        <!-- 添加主题色（用于移动浏览器） -->
    <meta name="theme-color" content="#34495e">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #1abc9c;
            --dark-color: #34495e;
            --light-color: #ecf0f1;
            --border-color: #ddd;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* 侧边栏 */
        .sidebar {
            width: 250px;
            background-color: var(--dark-color);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .sidebar-header h2 {
            font-size: 1.2rem;
            color: white;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-item {
            padding: 12px 20px;
            border-left: 4px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }
        
        .sidebar-item:hover {
            background-color: rgba(255,255,255,0.1);
            border-left-color: var(--primary-color);
        }
        
        .sidebar-item.active {
            background-color: rgba(255,255,255,0.1);
            border-left-color: var(--primary-color);
        }
        
        .sidebar-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* 主内容区 */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .header-title h1 {
            font-size: 1.5rem;
            color: var(--dark-color);
        }
        
        .user-menu {
            display: flex;
            align-items: center;
        }
        
        .user-menu span {
            margin-right: 15px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        /* 仪表盘卡片 */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .card-primary {
            border-top: 3px solid var(--primary-color);
        }
        
        .card-success {
            border-top: 3px solid var(--secondary-color);
        }
        
        .card-warning {
            border-top: 3px solid var(--warning-color);
        }
        
        .card-danger {
            border-top: 3px solid var(--danger-color);
        }
        
        .card-info {
            border-top: 3px solid var(--info-color);
        }
        
        .stat-card {
            text-align: center;
        }
        
        .stat-icon {
            font-size: 48px;
            color: rgba(0,0,0,0.15);
            position: absolute;
            top: 20px;
            right: 20px;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #777;
            font-size: 14px;
        }
        
        /* 图表卡片 */
        .chart-container {
            width: 100%;
            height: 300px;
            margin-bottom: 30px;
        }
        
        .chart-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* 表格样式 */
        .table-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .table tr:hover {
            background-color: #f8f9fa;
        }
        
        /* 分页控件 */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 12px;
            margin: 0 5px;
            border: 1px solid var(--border-color);
            background-color: white;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .pagination button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .pagination button:hover:not(.active) {
            background-color: #f5f5f5;
        }
        
        /* 表单控件 */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        /* 搜索栏 */
        .search-bar {
            display: flex;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* 内容区域 */
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* 加载动画 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 弹窗 */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            width: 50%;
            border-radius: 8px;
            max-width: 600px;
            position: relative;
        }
        
        .close-btn {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
        }
        
        /* 响应式调整 */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .chart-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 登录页面 -->
    <div id="login-page" style="display:none;">
        <div style="max-width: 400px; margin: 100px auto; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h1 style="text-align: center; margin-bottom: 20px;">管理员登录</h1>
            
            <div class="form-group">
                <label class="form-label">邮箱</label>
                <input type="email" id="login-email" class="form-control" placeholder="输入管理员邮箱">
            </div>
            
            <div class="form-group">
                <label class="form-label">密码</label>
                <input type="password" id="login-password" class="form-control" placeholder="输入密码">
            </div>
            
            <button id="login-btn" class="btn btn-primary" style="width: 100%;">登录</button>
            
            <div id="login-message" style="margin-top: 15px; color: var(--danger-color); text-align: center;"></div>
        </div>
    </div>

    <!-- 主仪表盘 -->
    <div class="container" id="dashboard-container" style="display:none;">
        <!-- 侧边栏 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Vision Pro 管理中心</h2>
            </div>
            
            <ul class="sidebar-menu">
                <li class="sidebar-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i> 控制台
                </li>
                <li class="sidebar-item" data-section="users">
                    <i class="fas fa-users"></i> 用户管理
                </li>
                <li class="sidebar-item" data-section="contents">
                    <i class="fas fa-film"></i> 内容管理
                </li>
                <li class="sidebar-item" data-section="orders">
                    <i class="fas fa-shopping-cart"></i> 订单管理
                </li>
                <li class="sidebar-item" data-section="payments">
                    <i class="fas fa-money-bill-wave"></i> 支付管理
                </li>
                <li class="sidebar-item" data-section="comments">
                    <i class="fas fa-comments"></i> 评论管理
                </li>
                <li class="sidebar-item" data-section="notifications">
                    <i class="fas fa-bell"></i> 通知管理
                </li>
                <li class="sidebar-item" data-section="reports">
                    <i class="fas fa-chart-bar"></i> 统计报表
                </li>
                <li class="sidebar-item" data-section="settings">
                    <i class="fas fa-cog"></i> 系统设置
                </li>
                <li class="sidebar-item" data-section="logs">
                    <i class="fas fa-history"></i> 操作日志
                </li>
            </ul>
        </aside>

        <!-- 主内容区 -->
        <div class="main-content">
            <header class="header">
                <div class="header-title">
                    <h1 id="page-title">控制台</h1>
                </div>
                <div class="user-menu">
                    <span id="admin-name">管理员</span>
                    <button id="logout-btn" class="btn btn-danger">
                        <i class="fas fa-sign-out-alt"></i> 退出
                    </button>
                </div>
            </header>

            <!-- 控制台页面 -->
            <section id="dashboard-section" class="content-section active">
                <div class="dashboard-cards">
                    <div class="card card-primary stat-card">
                        <i class="fas fa-users stat-icon"></i>
                        <div class="stat-value" id="total-users">0</div>
                        <div class="stat-label">总用户数</div>
                    </div>
                    
                    <div class="card card-success stat-card">
                        <i class="fas fa-film stat-icon"></i>
                        <div class="stat-value" id="total-contents">0</div>
                        <div class="stat-label">发布内容数</div>
                    </div>
                    
                    <div class="card card-warning stat-card">
                        <i class="fas fa-shopping-cart stat-icon"></i>
                        <div class="stat-value" id="total-orders">0</div>
                        <div class="stat-label">总订单数</div>
                    </div>
                    
                    <div class="card card-info stat-card">
                        <i class="fas fa-yen-sign stat-icon"></i>
                        <div class="stat-value" id="total-revenue">¥0</div>
                        <div class="stat-label">总收入</div>
                    </div>
                </div>
                
                <div class="chart-row">
                    <div class="card">
                        <h3>近7天新用户</h3>
                        <canvas id="user-chart" height="200"></canvas>
                    </div>
                    
                    <div class="card">
                        <h3>近7天收入</h3>
                        <canvas id="revenue-chart" height="200"></canvas>
                    </div>
                </div>
                
                <div class="chart-row">
                    <div class="card">
                        <h3>内容类型分布</h3>
                        <canvas id="content-type-chart" height="200"></canvas>
                    </div>
                    
                    <div class="card">
                        <h3>订单类型分布</h3>
                        <canvas id="order-type-chart" height="200"></canvas>
                    </div>
                </div>
                
                <div class="table-container">
                    <h3>待审核内容</h3>
                    <table class="table" id="pending-contents-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>标题</th>
                                <th>类型</th>
                                <th>创作者</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="text-center">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 其他页面占位 -->
            <section id="users-section" class="content-section">
                <h2>用户管理</h2>
                           <div class="search-bar">
                <input type="text" id="user-search" placeholder="搜索用户名或邮箱">
                <select id="user-role">
                    <option value="">所有角色</option>
                    <option value="user">普通用户</option>
                    <option value="creator">创作者</option>
                    <option value="admin">管理员</option>
                </select>
                <select id="user-status">
                    <option value="">所有状态</option>
                    <option value="active">活跃</option>
                    <option value="suspended">已暂停</option>
                    <option value="deleted">已删除</option>
                </select>
                <button onclick="loadUsers()">搜索</button>
            </div>
            </section>
            
            <section id="contents-section" class="content-section">
                <h2>内容管理</h2>
            <div class="search-bar">
                <input type="text" id="content-search" placeholder="搜索标题或标签">
                <select id="content-type">
                    <option value="">所有类型</option>
                    <option value="180_video">180°视频</option>
                    <option value="180_photo">180°照片</option>
                    <option value="360_video">360°视频</option>
                    <option value="360_photo">360°照片</option>
                    <option value="spatial_video">空间视频</option>
                    <option value="spatial_photo">空间照片</option>
                </select>
                <select id="content-status">
                    <option value="">所有状态</option>
                    <option value="draft">草稿</option>
                    <option value="pending_review">待审核</option>
                    <option value="approved">已批准</option>
                    <option value="rejected">已拒绝</option>
                    <option value="published">已发布</option>
                    <option value="archived">已归档</option>
                </select>
                <button onclick="loadContents()">搜索</button>
            </div>
            </section>
            
            <section id="orders-section" class="content-section">
                <h2>订单管理</h2>
            <div class="search-bar">
                <input type="text" id="order-search" placeholder="搜索订单号或描述">
                <select id="order-type">
                    <option value="">所有类型</option>
                    <option value="subscription">订阅</option>
                    <option value="content">内容购买</option>
                    <option value="tip">打赏</option>
                </select>
                <select id="order-status">
                    <option value="">所有状态</option>
                    <option value="pending">待支付</option>
                    <option value="paid">已支付</option>
                    <option value="failed">支付失败</option>
                    <option value="cancelled">已取消</option>
                    <option value="refunded">已退款</option>
                </select>
                <button onclick="loadOrders()">搜索</button>
            </div>
            </section>
            
            <section id="payments-section" class="content-section">
                <h2>支付管理</h2>
            <div class="card">
                <h3>平台收入</h3>
                <div class="search-bar">
                    <select id="income-period">
                        <option value="today">今日</option>
                        <option value="week">本周</option>
                        <option value="month" selected>本月</option>
                        <option value="year">本年</option>
                    </select>
                    <button onclick="loadPlatformIncome()">查询</button>
                </div>
                <div id="income-stats"></div>
            </div>
            </section>
            
            <section id="comments-section" class="content-section">
                <h2>评论管理</h2>
            <div class="search-bar">
                <select id="comment-status">
                    <option value="flagged" selected>被举报</option>
                    <option value="active">正常</option>
                    <option value="hidden">已隐藏</option>
                    <option value="deleted">已删除</option>
                </select>
                <button onclick="loadComments()">查询</button>
            </div>
            </section>
            
            <section id="notifications-section" class="content-section">
                <h2>通知管理</h2>
                <!-- 通知管理内容 -->
            </section>
            
            <section id="reports-section" class="content-section">
                <h2>统计报表</h2>
                <!-- 统计报表内容 -->
            </section>
            
            <section id="settings-section" class="content-section">
                <h2>系统设置</h2>
                <!-- 系统设置内容 -->
            </section>
            
            <section id="logs-section" class="content-section">
                <h2>操作日志</h2>
            <div class="search-bar">
                <select id="log-admin">
                    <option value="">所有管理员</option>
                </select>
                <select id="log-action">
                    <option value="">所有操作</option>
                    <option value="list_users">查看用户列表</option>
                    <option value="view_user_details">查看用户详情</option>
                    <option value="update_user">更新用户</option>
                    <option value="update_user_status">更新用户状态</option>
                    <option value="list_contents">查看内容列表</option>
                    <option value="view_content_details">查看内容详情</option>
                    <option value="update_content_status">更新内容状态</option>
                    <option value="review_content">审核内容</option>
                    <option value="list_orders">查看订单列表</option>
                    <option value="view_order_details">查看订单详情</option>
                    <option value="update_order_status">更新订单状态</option>
                    <option value="view_platform_income">查看平台收入</option>
                    <option value="view_withdrawal_requests">查看提现请求</option>
                    <option value="process_withdrawal">处理提现</option>
                    <option value="list_flagged_comments">查看举报评论</option>
                    <option value="update_comment_status">更新评论状态</option>
                    <option value="view_system_settings">查看系统设置</option>
                    <option value="update_system_settings">更新系统设置</option>
                </select>
                <button onclick="loadAdminLogs()">查询</button>
            </div>
            </section>
        </div>
    </div>

    <!-- 引入脚本 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
        <script src="fixed-admin-dashboard.js"></script>

    <script>
        let token = localStorage.getItem('adminToken');
        let currentSection = 'dashboard';

        document.addEventListener('DOMContentLoaded', () => {
            // 检查是否已登录
            if (!token) {
                showLoginPage();
            } else {
                hideLoginPage();
                loadDashboardData();
            }

            // 登录按钮点击事件
            document.getElementById('login-btn').addEventListener('click', login);

            // 退出按钮点击事件
            document.getElementById('logout-btn').addEventListener('click', logout);

            // 侧边栏菜单点击事件
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.getAttribute('data-section');
                    showSection(section);
                });
            });
        });

        // 显示登录页面
        function showLoginPage() {
            document.getElementById('login-page').style.display = 'block';
            document.getElementById('dashboard-container').style.display = 'none';
        }

        // 隐藏登录页面
        function hideLoginPage() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'flex';
        }

        // 登录函数
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                document.getElementById('login-message').textContent = '请输入邮箱和密码';
                return;
            }

            try {
                const response = await fetch('http://localhost:5001/api/users/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success) {
                    // 检查是否为管理员
                    if (data.data.user.role !== 'admin') {
                        document.getElementById('login-message').textContent = '您不是管理员，无法登录管理中心';
                        return;
                    }

                    token = data.data.token;
                    localStorage.setItem('adminToken', token);
                    document.getElementById('admin-name').textContent = data.data.user.username;
                    hideLoginPage();
                    loadDashboardData();
                } else {
                    document.getElementById('login-message').textContent = data.message || '登录失败';
                }
            } catch (error) {
                console.error('登录错误:', error);
                document.getElementById('login-message').textContent = '登录请求失败，请检查网络连接';
            }
        }

        // 退出登录
        function logout() {
            token = null;
            localStorage.removeItem('adminToken');
            showLoginPage();
        }

        // 切换显示的内容区域
        function showSection(section) {
            // 更新活跃菜单项
            document.querySelectorAll('.sidebar-item').forEach(item => {
                if (item.getAttribute('data-section') === section) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // 更新页面标题
            const titles = {
                'dashboard': '控制台',
                'users': '用户管理',
                'contents': '内容管理',
                'orders': '订单管理',
                'payments': '支付管理',
                'comments': '评论管理',
                'notifications': '通知管理',
                'reports': '统计报表',
                'settings': '系统设置',
                'logs': '操作日志'
            };
            document.getElementById('page-title').textContent = titles[section] || '控制台';

            // 更新显示的内容区域
            document.querySelectorAll('.content-section').forEach(item => {
                if (item.id === `${section}-section`) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // 加载对应页面的数据
            switch (section) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'users':
                    // 加载用户数据
                    break;
                case 'contents':
                    // 加载内容数据
                    break;
                // 更多页面的数据加载...
            }

            currentSection = section;
        }

        // 加载仪表盘数据
        async function loadDashboardData() {
            try {
                const response = await fetch('http://localhost:5001/api/admin/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // 更新统计数字
                    document.getElementById('total-users').textContent = data.data.users.total;
                    document.getElementById('total-contents').textContent = data.data.content.published;
                    document.getElementById('total-orders').textContent = data.data.orders.completed;
                    document.getElementById('total-revenue').textContent = `¥${data.data.orders.revenue.toFixed(2)}`;

                    // 绘制用户图表
                    drawUserChart(data.data.last7DaysUsers);

                    // 绘制收入图表
                    drawRevenueChart(data.data.last7DaysRevenue);

                    // 绘制内容类型分布图
                    drawContentTypeChart(data.data.contentTypeDistribution);

                    // 绘制订单类型分布图
                    drawOrderTypeChart(data.data.orderTypeDistribution);

                    // 加载待审核内容
                    loadPendingContents();
                }
            } catch (error) {
                console.error('加载仪表盘数据失败:', error);
            }
        }

        // 绘制用户图表
        function drawUserChart(userData) {
            const ctx = document.getElementById('user-chart').getContext('2d');
            
            // 清除旧图表
            if (window.userChart) {
                window.userChart.destroy();
            }
            
            // 准备数据
            const labels = userData.map(item => item.date);
            const data = userData.map(item => item.count);
            
            // 创建新图表
            window.userChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '新用户数',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // 绘制收入图表
        function drawRevenueChart(revenueData) {
            const ctx = document.getElementById('revenue-chart').getContext('2d');
            
            // 清除旧图表
            if (window.revenueChart) {
                window.revenueChart.destroy();
            }
            
            // 准备数据
            const labels = revenueData.map(item => item.date);
            const data = revenueData.map(item => item.amount);
            
            // 创建新图表
            window.revenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '收入(¥)',
                        data: data,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

// 绘制内容类型分布图
        function drawContentTypeChart(contentTypeData) {
            const ctx = document.getElementById('content-type-chart').getContext('2d');
            
            // 清除旧图表
            if (window.contentTypeChart) {
                window.contentTypeChart.destroy();
            }
            
            // 准备数据
            const labels = contentTypeData.map(item => {
                // 格式化内容类型名称
                switch(item._id) {
                    case '180_video': return '180°视频';
                    case '180_photo': return '180°照片';
                    case '360_video': return '360°视频';
                    case '360_photo': return '360°照片';
                    case 'spatial_video': return '空间视频';
                    case 'spatial_photo': return '空间照片';
                    default: return item._id;
                }
            });
            const data = contentTypeData.map(item => item.count);
            const backgroundColors = [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 159, 64, 0.6)'
            ];
            
            // 创建新图表
            window.contentTypeChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    legend: {
                        position: 'right'
                    }
                }
            });
        }

        // 绘制订单类型分布图
        function drawOrderTypeChart(orderTypeData) {
            const ctx = document.getElementById('order-type-chart').getContext('2d');
            
            // 清除旧图表
            if (window.orderTypeChart) {
                window.orderTypeChart.destroy();
            }
            
            // 准备数据
            const labels = orderTypeData.map(item => {
                // 格式化订单类型名称
                switch(item._id) {
                    case 'subscription': return '订阅';
                    case 'content': return '内容购买';
                    case 'tip': return '打赏';
                    default: return item._id;
                }
            });
            const data = orderTypeData.map(item => item.amount);
            const backgroundColors = [
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 99, 132, 0.6)',
                'rgba(255, 206, 86, 0.6)'
            ];
            
            // 创建新图表
            window.orderTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    legend: {
                        position: 'right'
                    }
                }
            });
        }

        // 加载待审核内容
        async function loadPendingContents() {
            try {
                const response = await fetch('http://localhost:5001/api/admin/contents?status=pending_review&limit=5', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const tableBody = document.querySelector('#pending-contents-table tbody');
                    tableBody.innerHTML = '';

                    if (data.data.contents.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无待审核内容</td></tr>';
                    } else {
                        data.data.contents.forEach(content => {
                            const row = document.createElement('tr');
                            const createdAt = new Date(content.createdAt).toLocaleString();
                            
                            row.innerHTML = `
                                <td>${content._id}</td>
                                <td>${content.title['zh-CN'] || content.title['en-US'] || '无标题'}</td>
                                <td>${formatContentType(content.contentType)}</td>
                                <td>${content.creatorId ? content.creatorId.username : '未知'}</td>
                                <td>${createdAt}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="reviewContent('${content._id}', true)">
                                        <i class="fas fa-check"></i> 批准
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="reviewContent('${content._id}', false)">
                                        <i class="fas fa-times"></i> 拒绝
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    }
                }
            } catch (error) {
                console.error('加载待审核内容失败:', error);
            }
        }

        // 审核内容
        async function reviewContent(contentId, approved) {
            const reviewNote = prompt('请输入审核意见:');
            if (reviewNote === null) return; // 用户取消了输入
            
            try {
                const response = await fetch(`http://localhost:5001/api/admin/contents/${contentId}/review`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        approved,
                        reviewNote
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`内容已${approved ? '批准' : '拒绝'}`);
                    
                    // 如果当前在仪表盘页面，刷新待审核内容列表
                    if (currentSection === 'dashboard') {
                        loadPendingContents();
                    }
                } else {
                    alert(`操作失败: ${data.message}`);
                }
            } catch (error) {
                console.error('审核内容失败:', error);
                alert('操作失败，请检查网络连接');
            }
        }

        // 格式化内容类型
        function formatContentType(type) {
            switch(type) {
                case '180_video': return '180°视频';
                case '180_photo': return '180°照片';
                case '360_video': return '360°视频';
                case '360_photo': return '360°照片';
                case 'spatial_video': return '空间视频';
                case 'spatial_photo': return '空间照片';
                default: return type;
            }
        }

        // 加载用户管理页面
        async function loadUsers(page = 1) {
            if (currentSection !== 'users') return;
            
            try {
                const search = document.getElementById('user-search') ? document.getElementById('user-search').value : '';
                const role = document.getElementById('user-role') ? document.getElementById('user-role').value : '';
                const status = document.getElementById('user-status') ? document.getElementById('user-status').value : '';
                
                let query = `page=${page}&limit=10`;
                if (search) query += `&search=${encodeURIComponent(search)}`;
                if (role) query += `&role=${role}`;
                if (status) query += `&status=${status}`;
                
                const response = await fetch(`http://localhost:5001/api/admin/users?${query}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const usersSection = document.getElementById('users-section');
                    
                    // 如果是首次加载，添加搜索栏和表格
                    if (!document.getElementById('users-table')) {
                        usersSection.innerHTML = `
                            <h2>用户管理</h2>
                            
                            <div class="search-bar">
                                <input type="text" id="user-search" class="search-input" placeholder="搜索用户名或邮箱">
                                <select id="user-role" class="form-control">
                                    <option value="">所有角色</option>
                                    <option value="user">普通用户</option>
                                    <option value="creator">创作者</option>
                                    <option value="admin">管理员</option>
                                </select>
                                <select id="user-status" class="form-control">
                                    <option value="">所有状态</option>
                                    <option value="active">活跃</option>
                                    <option value="suspended">已暂停</option>
                                    <option value="deleted">已删除</option>
                                </select>
                                <button class="btn btn-primary" onclick="loadUsers()">
                                    <i class="fas fa-search"></i> 搜索
                                </button>
                            </div>
                            
                            <div class="table-container">
                                <table class="table" id="users-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>用户名</th>
                                            <th>邮箱</th>
                                            <th>角色</th>
                                            <th>状态</th>
                                            <th>注册时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div id="users-pagination" class="pagination"></div>
                        `;
                        
                        // 添加搜索按钮点击事件
                        document.getElementById('users-section').querySelector('button').addEventListener('click', () => loadUsers());
                    }
                    
                    // 填充用户表格
                    const tableBody = document.getElementById('users-table').querySelector('tbody');
                    tableBody.innerHTML = '';
                    
                    if (data.data.users.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">暂无用户数据</td></tr>';
                    } else {
                        data.data.users.forEach(user => {
                            const row = document.createElement('tr');
                            const createdAt = new Date(user.createdAt).toLocaleString();
                            
                            row.innerHTML = `
                                <td>${user._id}</td>
                                <td>${user.username}</td>
                                <td>${user.email}</td>
                                <td>${formatUserRole(user.role)}</td>
                                <td>${formatUserStatus(user.status)}</td>
                                <td>${createdAt}</td>
                                <td>
                                    <button class="btn btn-primary btn-sm" onclick="viewUserDetails('${user._id}')">
                                        <i class="fas fa-eye"></i> 详情
                                    </button>
                                    <button class="btn ${user.status === 'active' ? 'btn-warning' : 'btn-success'} btn-sm" onclick="changeUserStatus('${user._id}', '${user.status === 'active' ? 'suspended' : 'active'}')">
                                        <i class="fas ${user.status === 'active' ? 'fa-ban' : 'fa-check'}"></i> ${user.status === 'active' ? '禁用' : '启用'}
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    }
                    
                    // 生成分页控件
                    generatePagination('users-pagination', data.data.pagination, loadUsers);
                }
            } catch (error) {
                console.error('加载用户列表失败:', error);
            }
        }

        // 用户详情
        async function viewUserDetails(userId) {
            try {
                const response = await fetch(`http://localhost:5001/api/admin/users/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const user = data.data.user;
                    const stats = data.data.stats;
                    
                    // 创建用户详情弹窗
                    if (!document.getElementById('user-details-modal')) {
                        const modal = document.createElement('div');
                        modal.id = 'user-details-modal';
                        modal.className = 'modal';
                        modal.innerHTML = `
                            <div class="modal-content">
                                <span class="close-btn" onclick="closeModal('user-details-modal')">&times;</span>
                                <h2>用户详情</h2>
                                <div id="user-details-body"></div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    }
                    
                    // 填充用户详情
                    const detailsBody = document.getElementById('user-details-body');
                    detailsBody.innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <p><strong>ID:</strong> ${user._id}</p>
                            <p><strong>用户名:</strong> ${user.username}</p>
                            <p><strong>邮箱:</strong> ${user.email}</p>
                            <p><strong>角色:</strong> ${formatUserRole(user.role)}</p>
                            <p><strong>状态:</strong> ${formatUserStatus(user.status)}</p>
                            <p><strong>注册时间:</strong> ${new Date(user.createdAt).toLocaleString()}</p>
                            <p><strong>最后登录:</strong> ${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleString() : '未登录'}</p>
                            <p><strong>内容数量:</strong> ${stats.contentCount}</p>
                            <p><strong>订阅状态:</strong> ${stats.hasSubscription ? '已订阅' : '未订阅'}</p>
                        </div>
                        
                        <h3>最近订单</h3>
                        <div class="table-container" style="max-height: 200px; overflow-y: auto;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>订单号</th>
                                        <th>类型</th>
                                        <th>金额</th>
                                        <th>状态</th>
                                        <th>时间</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${stats.recentOrders.length > 0 ? 
                                        stats.recentOrders.map(order => `
                                            <tr>
                                                <td>${order.orderNo}</td>
                                                <td>${formatOrderType(order.orderType)}</td>
                                                <td>¥${order.amount.toFixed(2)}</td>
                                                <td>${formatOrderStatus(order.paymentStatus)}</td>
                                                <td>${new Date(order.createdAt).toLocaleString()}</td>
                                            </tr>
                                        `).join('') : 
                                        '<tr><td colspan="5" style="text-align: center;">暂无订单记录</td></tr>'
                                    }
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    // 显示弹窗
                    document.getElementById('user-details-modal').style.display = 'block';
                }
            } catch (error) {
                console.error('获取用户详情失败:', error);
                alert('获取用户详情失败，请检查网络连接');
            }
        }

        // 修改用户状态
        async function changeUserStatus(userId, status) {
            const reason = prompt('请输入修改原因:');
            if (reason === null) return; // 用户取消了输入
            
            try {
                const response = await fetch(`http://localhost:5001/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status,
                        reason
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`用户状态已更新为${formatUserStatus(status)}`);
                    
                    // 如果当前在用户管理页面，刷新用户列表
                    if (currentSection === 'users') {
                        loadUsers();
                    }
                } else {
                    alert(`操作失败: ${data.message}`);
                }
            } catch (error) {
                console.error('更新用户状态失败:', error);
                alert('操作失败，请检查网络连接');
            }
        }

        // 格式化用户角色
        function formatUserRole(role) {
            switch(role) {
                case 'user': return '普通用户';
                case 'creator': return '创作者';
                case 'admin': return '管理员';
                default: return role;
            }
        }

        // 格式化用户状态
        function formatUserStatus(status) {
            switch(status) {
                case 'active': return '活跃';
                case 'suspended': return '已暂停';
                case 'deleted': return '已删除';
                default: return status;
            }
        }

        // 格式化订单类型
        function formatOrderType(type) {
            switch(type) {
                case 'subscription': return '订阅';
                case 'content': return '内容购买';
                case 'tip': return '打赏';
                default: return type;
            }
        }

        // 格式化订单状态
        function formatOrderStatus(status) {
            switch(status) {
                case 'pending': return '待支付';
                case 'paid': return '已支付';
                case 'failed': return '支付失败';
                case 'cancelled': return '已取消';
                case 'refunded': return '已退款';
                default: return status;
            }
        }

        // 生成分页控件
        function generatePagination(containerId, pagination, callback) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (pagination.pages <= 1) return;
            
            // 上一页按钮
            if (pagination.page > 1) {
                const prevButton = document.createElement('button');
                prevButton.textContent = '上一页';
                prevButton.onclick = () => callback(pagination.page - 1);
                container.appendChild(prevButton);
            }
            
            // 页码按钮
            let startPage = Math.max(1, pagination.page - 2);
            let endPage = Math.min(pagination.pages, pagination.page + 2);
            
            // 确保显示至少5个页码按钮（如果有足够的页面）
            if (endPage - startPage + 1 < 5) {
                if (startPage === 1) {
                    endPage = Math.min(5, pagination.pages);
                } else if (endPage === pagination.pages) {
                    startPage = Math.max(1, pagination.pages - 4);
                }
            }
            
            // 显示第一页和省略号
            if (startPage > 1) {
                const firstButton = document.createElement('button');
                firstButton.textContent = '1';
                firstButton.onclick = () => callback(1);
                container.appendChild(firstButton);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.margin = '0 5px';
                    container.appendChild(ellipsis);
                }
            }
            
            // 页码按钮
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.onclick = () => callback(i);
                
                if (i === pagination.page) {
                    pageButton.classList.add('active');
                }
                
                container.appendChild(pageButton);
            }
            
            // 显示最后一页和省略号
            if (endPage < pagination.pages) {
                if (endPage < pagination.pages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.margin = '0 5px';
                    container.appendChild(ellipsis);
                }
                
                const lastButton = document.createElement('button');
                lastButton.textContent = pagination.pages;
                lastButton.onclick = () => callback(pagination.pages);
                container.appendChild(lastButton);
            }
            
            // 下一页按钮
            if (pagination.page < pagination.pages) {
                const nextButton = document.createElement('button');
                nextButton.textContent = '下一页';
                nextButton.onclick = () => callback(pagination.page + 1);
                container.appendChild(nextButton);
            }
        }

        // 关闭弹窗
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
    </script>
</body>
</html>